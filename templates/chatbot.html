{% extends "base.html" %}
{% set title = "Chat" %}
{% block content %}

<div class="max-w-3xl mx-auto card p-6 fade-in">

  <h1 class="text-2xl font-bold mb-4 text-indigo-300">Chat Support</h1>

  <!-- Chat window -->
  <div id="chat" 
       class="h-80 overflow-y-auto p-4 rounded-xl bg-white/5 border border-white/10 backdrop-blur-sm shadow-inner space-y-2">
    
    <div class="bubble bubble-bot mb-2">
      <strong>SSRVM-BE:</strong> 
      Hi {{ session.user.name }}, I’m here to support you. What’s on your mind?
    </div>

  </div>

  <!-- Input area -->
  <form id="chat-form" class="mt-4 flex gap-3" onsubmit="return sendMsg(event)">
    <input id="chat-input"
           class="flex-1 rounded-xl p-3 bg-white/5 border border-white/15 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
           placeholder="Type your message..."
           autocomplete="off">

    <button class="px-6 py-2 rounded-xl bg-gradient-to-r from-indigo-500 to-indigo-700 text-white shadow hover:scale-[1.03] transition">
      Send
    </button>
  </form>

  <div class="mt-3 text-xs text-slate-400">
    Note: I’m a supportive assistant, not a medical professional. 
    If you're in danger, contact local emergency services.
  </div>

</div>

<!-- --------------------------
      CHAT LOGIC (UPDATED)
---------------------------- -->
<script>
const delay = (ms) => new Promise(res => setTimeout(res, ms));
const chat = document.getElementById('chat');
const input = document.getElementById('chat-input');

function addBubble(text, who='user') {
  const div = document.createElement('div');
  div.className = 'bubble ' + (who==='user' ? 'bubble-user' : 'bubble-bot') + ' mb-2';
  div.innerHTML = (who==='user' ? '' : '<strong>SSRVM:</strong> ') + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}


/* ⚡ NEW: clean function to insert counsellor buttons */
function showCounsellorButtons(originalText) {
  // remove existing button sets to avoid duplicates
  document.querySelectorAll(".counsellor-buttons").forEach(x => x.remove());

  const wrap = document.createElement('div');
  wrap.className = 'counsellor-buttons mb-2 flex gap-3 animate-fadein';
  wrap.innerHTML = `
    <button class="px-3 py-1 rounded bg-emerald-600 text-white shadow hover:scale-[1.02] transition" id="btn-yes">
      Notify counsellor
    </button>
    <button class="px-3 py-1 rounded bg-white/10 border border-white/20 text-slate-200 hover:bg-white/20 transition" id="btn-no">
      No, thanks
    </button>
  `;

  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;

  wrap.querySelector('#btn-yes').onclick = async () => {
    confetti();
    wrap.remove();
    await fetch('{{ url_for("api_counsellor_request") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ want: true, note: originalText })
    });
    addBubble("Okay. I've noted your request to meet your counsellor. They will be contacted by the student support team.", 'bot');
  };

  wrap.querySelector('#btn-no').onclick = async () => {
    wrap.remove();
    await fetch('{{ url_for("api_counsellor_request") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ want: false, note: originalText })
    });
    addBubble("No problem. I'm still here for you. Would you like a self-care suggestion or a short grounding exercise?", 'bot');
  };
}



async function sendMsg(e) {
  e.preventDefault();
  const text = input.value.trim();
  if (!text) return false;

  addBubble(text, 'user');
  input.value='';

  const typing = document.createElement('div');
  typing.className = 'bubble bubble-bot typing mb-2';
  typing.textContent = 'SSRVM is typing…';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  try {
    const res = await fetch('{{ url_for("api_chatbot") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });

    const data = await res.json();

    await delay(700 + Math.random()*1000);
    typing.remove();
    addBubble(data.reply, 'bot');

    /* NEW: Always show buttons when ask_counsellor = true */
    if (data.ask_counsellor === true) {
      showCounsellorButtons(text);
    }

  } catch (e) {
    typing.remove();
    addBubble("Sorry, I had trouble responding. Please try again.", 'bot');
  }

  return false;
}
</script>

<!-- Animation -->
<style>
@keyframes fadein {
  from { opacity:0; transform:translateY(4px); }
  to { opacity:1; transform:translateY(0); }
}
.animate-fadein { animation: fadein .25s ease-out; }
</style>

{% endblock %}
