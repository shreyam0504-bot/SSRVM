{% extends "base.html" %}
{% set title = "Chat" %}
{% block content %}
<div class="max-w-3xl mx-auto card p-6">
  <h1 class="text-xl font-bold mb-3">Chat support</h1>
  <div id="chat" class="h-80 overflow-y-auto p-2 bg-white border rounded">
    <div class="bubble bubble-bot mb-2"><strong>SSRVM-BE:</strong> Hi {{ session.user.name }}, I’m here to support you. What’s on your mind?</div>
  </div>
  <form id="chat-form" class="mt-3 flex gap-2" onsubmit="return sendMsg(event)">
    <input id="chat-input" class="flex-1 border rounded p-2" placeholder="Type your message..." autocomplete="off">
    <button class="px-4 py-2 rounded-full bg-gradient-to-r from-indigo-500 to-indigo-700 text-white shadow hover:opacity-90 transition">Send</button>
  </form>
  <div class="mt-2 text-xs text-slate-500">Note: I’m a supportive assistant, not a medical professional. If you're in danger, contact local emergency services.</div>
</div>

<script>
const delay = (ms) => new Promise(res => setTimeout(res, ms));
const chat = document.getElementById('chat');
const input = document.getElementById('chat-input');

function addBubble(text, who='user') {
  const div = document.createElement('div');
  div.className = 'bubble ' + (who==='user' ? 'bubble-user' : 'bubble-bot') + ' mb-2';
  div.innerHTML = (who==='user' ? '' : '<strong>SSRVM:</strong> ') + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMsg(e) {
  e.preventDefault();
  const text = input.value.trim();
  if (!text) return false;
  addBubble(text, 'user');
  input.value='';

  const typing = document.createElement('div');
  typing.className = 'bubble bubble-bot typing mb-2';
  typing.textContent = 'SSRVM is typing…';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  try {
    const res = await fetch('{{ url_for("api_chatbot") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    await delay(1000 + Math.random()*1200);
    typing.remove();
    addBubble(data.reply, 'bot');

    if (data.ask_counsellor) {
      const wrap = document.createElement('div');
      wrap.className = 'mb-2 flex gap-2';
      wrap.innerHTML = `
        <button class="px-3 py-1 rounded bg-emerald-600 text-white" id="btn-yes">Notify counsellor</button>
        <button class="px-3 py-1 rounded border" id="btn-no">No, thanks</button>
      `;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;

      wrap.querySelector('#btn-yes').onclick = async () => { confetti();
        wrap.remove();
        await fetch('{{ url_for("api_counsellor_request") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ want: true, note: text })
        });
        addBubble("Okay. I've noted your request to meet your counsellor. They will be contacted by the student support team.", 'bot');
      };
      wrap.querySelector('#btn-no').onclick = async () => {
        wrap.remove();
        await fetch('{{ url_for("api_counsellor_request") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ want: false, note: text })
        });
        addBubble("No problem. I'm still here for you. Would you like a self-care suggestion or a short grounding exercise?", 'bot');
      };
    }
  } catch (e) {
    typing.remove();
    addBubble("Sorry, I had trouble responding. Please try again.", 'bot');
  }
  return false;
}
</script>
{% endblock %}